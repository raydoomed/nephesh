<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>OpenManus - AI Intelligent Assistant</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/chat.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/history.css') }}">
    <!-- Import Axios for HTTP requests -->
    <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
    <!-- Import Vue.js -->
    <script src="https://cdn.jsdelivr.net/npm/vue@3.3.4/dist/vue.global.js"></script>
    <!-- Import Font Awesome icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Import Prism for code highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/themes/prism-tomorrow.min.css">
    <!-- Import MathJax for math rendering -->
    <script type="text/javascript" id="MathJax-script" async
        src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-svg.js">
        </script>
    <script type="text/javascript">
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            svg: {
                fontCache: 'global'
            }
        };
    </script>
    <!-- Import Google Fonts -->
    <link rel="stylesheet"
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap">
    <!-- Add page favicon -->
    <link rel="icon" href="{{ url_for('static', filename='images/favicon.ico') }}" type="image/x-icon">
    <!-- Add Meta theme color -->
    <meta name="theme-color" content="#0c1426">
</head>

<body>
    <!-- Page loading animation -->
    <div id="page-loader">
        <div class="loader-content">
            <div class="spinner">
                <div class="bounce1"></div>
                <div class="bounce2"></div>
                <div class="bounce3"></div>
            </div>
            <p>System starting...</p>
        </div>
    </div>

    <div id="app">
        <!-- New navigation bar design -->
        <nav class="main-nav">
            <div class="nav-container">
                <a href="{{ url_for('index') }}" class="brand" style="text-decoration: none;">
                    <img :src="isDarkTheme ? '{{ url_for('static', filename='images/logo_Gradient.png') }}' : '{{ url_for('static', filename='images/logo_black.png') }}'"
                        alt="OpenManus Logo" class="logo">
                    <h1>OpenManus <span class="version-badge">Beta</span></h1>
                </a>

                <div class="nav-controls">
                    <!-- Session ID display -->
                    <div class="session-id-display">
                        <i class="fas fa-fingerprint"></i>
                        <span>${sessionId || 'Not connected'}</span>
                    </div>

                    <!-- Add notification area in navbar -->
                    <div class="navbar-notification-area" v-if="navbarNotification.show">
                        <div class="navbar-notification" :class="navbarNotification.type">
                            <div class="notification-icon">
                                <i class="fas"
                                    :class="navbarNotification.type === 'success' ? 'fa-check-circle' :
                                   navbarNotification.type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'"></i>
                            </div>
                            <div class="notification-content">${navbarNotification.message}</div>
                        </div>
                    </div>

                    <!-- Connection status -->
                    <div class="status-container" :class="connectionStatus">
                        <span class="status-dot"></span>
                        <span class="status-text">${statusText}</span>
                    </div>

                    <!-- Add history button -->
                    <a href="/history" class="nav-button" title="ÂéÜÂè≤ËÆ∞ÂΩï">
                        <i class="fas fa-history"></i>
                    </a>

                    <button class="theme-toggle" @click="toggleTheme"
                        :title="isDarkTheme ? 'Switch to light mode' : 'Switch to dark mode'">
                        <i class="fas" :class="isDarkTheme ? 'fa-moon' : 'fa-sun'"></i>
                    </button>

                    <!-- Add configuration button -->
                    <button class="config-toggle" @click="toggleConfigPanel" :title="'Á≥ªÁªüÈÖçÁΩÆ'">
                        <i class="fas fa-wrench"></i>
                    </button>

                    <a href="https://github.com/mannaandpoem/OpenManus" target="_blank"
                        title="Visit the GitHub project repository" class="github-nav-link">
                        <i class="fab fa-github"></i>
                    </a>
                </div>
            </div>
        </nav>

        <!-- Main workspace -->
        <div class="workspace">
            <!-- Sidebar toolbar -->
            <div class="toolbox">
                <!-- Welcome panel -->
                <div class="tool-section system-info">
                    <div class="tool-header">
                        <i class="fas fa-info-circle"></i>
                        <h3>System Information</h3>
                    </div>
                    <div class="info-content">
                        <p class="system-info-text">
                            <span class="system-highlight">OpenManus</span> <span class="system-emoji">‚ú®</span> is an
                            intelligent agent platform based on
                            large language models <span class="system-emoji">ü§ñ</span>, integrating diverse tool
                            capabilities <span class="system-emoji">üõ†Ô∏è</span>, supporting complex task
                            execution <span class="system-emoji">üöÄ</span> and automation processes <span
                                class="system-emoji">‚öôÔ∏è</span>.
                        </p>
                    </div>
                </div>

                <div class="tool-section">
                    <div class="tool-header">
                        <i class="fas fa-bolt"></i>
                        <h3>Session Control</h3>
                    </div>
                    <div class="tool-buttons">
                        <button @click="createNewSession" class="primary-btn">
                            <i class="fas fa-plus"></i>
                            <span>New Session</span>
                        </button>
                        <button @click="terminateSession" :disabled="!isConnected" class="secondary-btn">
                            <i class="fas"
                                :class="[isProcessing && !isConnected ? 'fa-spinner fa-spin' : 'fa-stop']"></i>
                            <span>${isProcessing && !isConnected ? 'Terminating' : 'Terminate'}</span>
                        </button>
                    </div>
                </div>

                <!-- New File Browser Tool -->
                <div class="tool-section">
                    <div class="tool-header">
                        <i class="fas fa-folder-open"></i>
                        <h3>File Browser</h3>
                        <button @click="refreshFiles" class="refresh-btn" title="Refresh file list">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                    <div class="workspace-files">
                        <div v-if="workspaceFiles.length === 0" class="no-files">
                            <p>No files in workspace</p>
                        </div>
                        <ul v-else class="files-list">
                            <li v-for="file in workspaceFiles" :key="file.path" class="file-item">
                                <div class="file-icon"><i class="fas fa-file-alt"></i></div>
                                <div class="file-info">
                                    <div class="file-name">${file.name}</div>
                                    <div class="file-size">${formatFileSize(file.size)}</div>
                                </div>
                                <div class="file-actions">
                                    <button @click="downloadFile(file.path)" class="file-action-btn"
                                        title="Download file">
                                        <i class="fas fa-download"></i>
                                    </button>
                                    <button @click="deleteFile(file.path)" class="file-action-btn delete-btn"
                                        title="Delete file">
                                        <i class="fas fa-trash-alt"></i>
                                    </button>
                                </div>
                            </li>
                        </ul>
                    </div>
                </div>

                <!-- Tool List Section -->
                <div class="tool-section tools-container">
                    <div class="tool-header">
                        <i class="fas fa-tools"></i>
                        <h3>Tool List</h3>
                    </div>

                    <div class="tools-panel">
                        <ul class="tools-list" v-if="availableTools.length > 0">
                            <li v-for="tool in availableTools" :key="tool.name" class="tool-item">
                                <div class="tool-icon"><i class="fas fa-tools"></i></div>
                                <div class="tool-info">
                                    <div class="tool-name">${tool.name}</div>
                                    <div class="tool-description">${tool.description}</div>
                                </div>
                            </li>
                        </ul>
                        <p v-else class="no-tools">No tools loaded</p>
                    </div>
                </div>

                <!-- Copyright Section -->
                <div class="tool-section copyright-section">
                    <div class="copyright-content">
                        <p>¬© OpenManus</p>
                    </div>
                </div>
            </div>

            <!-- Chat area -->
            <div class="chat-section">
                <!-- Current task display -->
                <div class="current-task" v-if="lastUserMessage">
                    <div class="task-label">
                        <i class="fas fa-tasks"></i>
                        <span>Current Task:</span>
                    </div>
                    <div class="task-content">
                        <span v-html="formatMessage(lastUserMessage.content)"></span>
                    </div>
                </div>

                <!-- Message display area - converted to two-column layout -->
                <div class="messages-container-split">
                    <!-- Left side - Manus Agent -->
                    <div class="messages-column agent-messages" ref="agentMessagesContainer">
                        <div class="column-header">
                            <i class="fas fa-robot"></i>
                            <span>Manus Agent</span>
                        </div>

                        <div class="column-content">
                            <div v-for="(message, index) in agentMessages" :key="index"
                                :class="['message', message.role, message.class]">
                                <div class="message-header">
                                    <div class="message-role">
                                        <span>Manus</span>
                                    </div>
                                    <span class="message-time">${formatTime(message.time)}</span>
                                </div>
                                <div class="message-content" v-html="formatMessage(message.content)"></div>
                            </div>

                            <!-- Agent message loading status -->
                            <div v-if="isProcessing" class="processing-indicator">
                                <div class="thinking-container">
                                    <div class="manus-eyes-animation">
                                        <div class="manus-eye"></div>
                                        <div class="manus-eye"></div>
                                    </div>
                                    <span class="thinking-text" v-if="agentStatus.currentStep > 0">
                                        Manus is processing... (Step ${agentStatus.currentStep}/${agentStatus.maxSteps})
                                    </span>
                                    <span class="thinking-text" v-else>
                                        Manus is thinking...
                                    </span>
                                </div>
                            </div>
                        </div>

                        <!-- Input area inside agent panel -->
                        <div class="agent-input-area">
                            <div class="input-container">
                                <textarea v-model="userInput" @keydown.enter.ctrl="sendMessage"
                                    :disabled="isProcessing || !isConnected"
                                    placeholder="Enter command, Ctrl+Enter to send" ref="userInputArea"></textarea>

                                <div class="input-actions">
                                    <button class="action-btn" title="Upload File" @click.stop="openUploadModal">
                                        <i class="fas fa-paperclip"></i>
                                    </button>
                                    <input type="file" ref="fileInput" @change="handleFileUpload" style="display: none">
                                    <button class="send-btn" @click="sendMessage"
                                        :disabled="isProcessing || !isConnected || !userInput.trim()">
                                        <i class="fas fa-paper-plane"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Right side - OpenManus -->
                    <div class="messages-column tool-messages" ref="toolMessagesContainer"
                        v-show="toolMessages.length > 0">
                        <div class="column-header">
                            <i class="fas fa-tools"></i>
                            <span>OpenManus</span>
                        </div>

                        <!-- Current tool in use display -->
                        <div class="current-tool-display" v-if="currentToolInUse">
                            <i v-if="currentToolInUse === 'terminate'" class="fas fa-check-circle completed-icon"></i>
                            <i v-else class="fas fa-cog"></i>
                            <span v-if="currentToolInUse === 'terminate'">Manus is completed</span>
                            <span v-else>Manus in use: ${currentToolInUse}</span>
                        </div>

                        <div class="column-content">
                            <div v-for="(message, index) in toolMessages" :key="index"
                                :class="['message', message.role, message.class]">
                                <div class="message-header">
                                    <div class="message-role">
                                        <i class="fas fa-tools"></i>
                                        <span>${message.name || 'Tool Output'}</span>
                                    </div>
                                    <span class="message-time">${formatTime(message.time)}</span>
                                </div>

                                <div class="message-content">
                                    <!-- Image display -->
                                    <div v-if="message.base64_image" class="image-container">
                                        <div class="screenshot-note">
                                            <i class="fas fa-info-circle"></i> Current visible area screenshot
                                        </div>
                                        <img :src="'data:image/png;base64,' + message.base64_image" alt="Screenshot"
                                            class="message-image" @click="expandImage">
                                    </div>

                                    <!-- Text content -->
                                    <div v-if="message.content" v-html="formatMessage(message.content)"></div>

                                    <!-- Tool call display -->
                                    <div v-if="message.tool_calls && message.tool_calls.length > 0" class="tool-calls">
                                        <div v-for="(tool, toolIndex) in message.tool_calls" :key="toolIndex"
                                            class="tool-call">
                                            <div class="tool-call-header">
                                                <i class="fas fa-cog"></i>
                                                <span>${tool.function.name}</span>
                                            </div>
                                            <pre
                                                class="tool-args"><code class="language-json">${formatJson(tool.function.arguments)}</code></pre>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- File upload modal -->
        <div class="upload-modal" v-if="showUploadModal" @click.self="closeUploadModal">
            <div class="upload-modal-content">
                <div class="upload-modal-header">
                    <h3><i class="fas fa-upload"></i> Select upload method</h3>
                    <button class="close-btn" @click="closeUploadModal">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="upload-options-grid">
                    <div class="upload-option-card" @click="triggerFileUpload('workspace')">
                        <div class="option-icon">
                            <i class="fas fa-folder"></i>
                        </div>
                        <div class="option-text">
                            <h4>Upload to workspace</h4>
                            <p>Files will be saved to the server and can be used in multiple sessions</p>
                        </div>
                    </div>
                    <div class="upload-option-card" @click="triggerFileUpload('input')">
                        <div class="option-icon">
                            <i class="fas fa-file-import"></i>
                        </div>
                        <div class="option-text">
                            <h4>Load to input</h4>
                            <p>File content will be loaded directly to the input box, making it easier for direct
                                analysis</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Configuration panel -->
        <div class="config-panel" :class="{ 'active': showConfigPanel }">
            <div class="config-panel-header">
                <h2><i class="fas fa-wrench"></i> System Configuration</h2>
                <button @click="toggleConfigPanel" class="close-btn">
                    <i class="fas fa-times"></i>
                </button>
            </div>

            <div class="config-panel-content">
                <div class="config-tabs">
                    <button v-for="(section, key) in configSections" :key="key"
                        :class="['config-tab', {active: currentConfigTab === key}]" @click="currentConfigTab = key">
                        <i :class="['fas', section.icon]"></i>
                        <span>${section.name}</span>
                    </button>
                </div>

                <div class="config-tab-content">
                    <!-- LLM Configuration -->
                    <div v-if="currentConfigTab === 'llm'" class="config-section">
                        <h3>LLM Configuration</h3>
                        <div class="form-group">
                            <label for="llm-model">Model Name</label>
                            <input type="text" id="llm-model" v-model="config.llm.model">
                        </div>
                        <div class="form-group">
                            <label for="llm-base-url">API Base URL</label>
                            <input type="text" id="llm-base-url" v-model="config.llm.base_url">
                        </div>
                        <div class="form-group">
                            <label for="llm-api-key">API Key</label>
                            <input type="password" id="llm-api-key" v-model="config.llm.api_key">
                        </div>
                        <div class="form-group">
                            <label for="llm-max-tokens">Max Tokens</label>
                            <input type="number" id="llm-max-tokens" v-model.number="config.llm.max_tokens">
                        </div>
                        <div class="form-group">
                            <label for="llm-temperature">Temperature</label>
                            <input type="number" id="llm-temperature" v-model.number="config.llm.temperature" step="0.1"
                                min="0" max="2">
                        </div>
                        <div class="form-group">
                            <label for="llm-stream">Stream Response</label>
                            <input type="checkbox" id="llm-stream" v-model="config.llm.stream">
                        </div>

                        <!-- Vision model configuration -->
                        <h3>Vision Model Configuration</h3>
                        <div class="form-group">
                            <label for="vision-model">Vision Model Name</label>
                            <input type="text" id="vision-model" v-model="config.llm.vision.model">
                        </div>
                        <div class="form-group">
                            <label for="vision-base-url">Vision API Base URL</label>
                            <input type="text" id="vision-base-url" v-model="config.llm.vision.base_url">
                        </div>
                        <div class="form-group">
                            <label for="vision-api-key">Vision API Key</label>
                            <input type="password" id="vision-api-key" v-model="config.llm.vision.api_key">
                        </div>
                        <div class="form-group">
                            <label for="vision-max-tokens">Vision Max Tokens</label>
                            <input type="number" id="vision-max-tokens" v-model.number="config.llm.vision.max_tokens">
                        </div>
                        <div class="form-group">
                            <label for="vision-temperature">Vision Temperature</label>
                            <input type="number" id="vision-temperature" v-model.number="config.llm.vision.temperature"
                                step="0.1" min="0" max="2">
                        </div>
                    </div>

                    <!-- Browser configuration -->
                    <div v-if="currentConfigTab === 'browser'" class="config-section">
                        <h3>Browser Configuration</h3>
                        <div class="form-group">
                            <label for="browser-headless">Headless Mode</label>
                            <input type="checkbox" id="browser-headless" v-model="config.browser.headless">
                        </div>
                        <div class="form-group">
                            <label for="browser-disable-security">Disable Security Features</label>
                            <input type="checkbox" id="browser-disable-security"
                                v-model="config.browser.disable_security">
                        </div>
                        <!-- Proxy configuration -->
                        <h4>Proxy Configuration</h4>
                        <div class="form-group">
                            <label for="proxy-server">Proxy Server</label>
                            <input type="text" id="proxy-server" v-model="proxyServerConfig">
                        </div>
                        <div class="form-group">
                            <label for="proxy-username">Username</label>
                            <input type="text" id="proxy-username" v-model="proxyUsernameConfig">
                        </div>
                        <div class="form-group">
                            <label for="proxy-password">Password</label>
                            <input type="password" id="proxy-password" v-model="proxyPasswordConfig">
                        </div>
                    </div>

                    <!-- Search configuration -->
                    <div v-if="currentConfigTab === 'search'" class="config-section">
                        <h3>Search Configuration</h3>
                        <div class="form-group">
                            <label for="search-engine">Search Engine</label>
                            <select id="search-engine" v-model="config.search.engine">
                                <option value="Google">Google</option>
                                <option value="Baidu">Baidu</option>
                                <option value="DuckDuckGo">DuckDuckGo</option>
                                <option value="Bing">Bing</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="search-retry-delay">Retry Delay (seconds)</label>
                            <input type="number" id="search-retry-delay" v-model.number="config.search.retry_delay">
                        </div>
                        <div class="form-group">
                            <label for="search-max-retries">Max Retries</label>
                            <input type="number" id="search-max-retries" v-model.number="config.search.max_retries">
                        </div>
                    </div>

                    <!-- Sandbox configuration -->
                    <div v-if="currentConfigTab === 'sandbox'" class="config-section">
                        <h3>Sandbox Configuration</h3>
                        <div class="form-group">
                            <label for="sandbox-use-sandbox">Enable Sandbox</label>
                            <input type="checkbox" id="sandbox-use-sandbox" v-model="config.sandbox.use_sandbox">
                        </div>
                        <div class="form-group">
                            <label for="sandbox-image">Image</label>
                            <input type="text" id="sandbox-image" v-model="config.sandbox.image">
                        </div>
                        <div class="form-group">
                            <label for="sandbox-memory-limit">Memory Limit</label>
                            <input type="text" id="sandbox-memory-limit" v-model="config.sandbox.memory_limit">
                        </div>
                        <div class="form-group">
                            <label for="sandbox-cpu-limit">CPU Limit</label>
                            <input type="number" id="sandbox-cpu-limit" v-model.number="config.sandbox.cpu_limit"
                                step="0.1">
                        </div>
                        <div class="form-group">
                            <label for="sandbox-timeout">Timeout (seconds)</label>
                            <input type="number" id="sandbox-timeout" v-model.number="config.sandbox.timeout">
                        </div>
                        <div class="form-group">
                            <label for="sandbox-network-enabled">Enable Network</label>
                            <input type="checkbox" id="sandbox-network-enabled"
                                v-model="config.sandbox.network_enabled">
                        </div>
                    </div>

                    <!-- Server configuration -->
                    <div v-if="currentConfigTab === 'server'" class="config-section">
                        <h3>Server Configuration</h3>
                        <div class="form-group">
                            <label for="server-host">Host Address</label>
                            <input type="text" id="server-host" v-model="config.server.host">
                        </div>
                        <div class="form-group">
                            <label for="server-port">Port Number</label>
                            <input type="number" id="server-port" v-model.number="config.server.port">
                        </div>
                    </div>
                </div>

                <div class="config-actions">
                    <button @click="saveConfig" class="save-btn primary-btn">
                        <i class="fas fa-save"></i> Save Configuration
                    </button>
                    <button @click="resetConfig" class="reset-btn secondary-btn">
                        <i class="fas fa-undo"></i> Reset
                    </button>
                </div>
            </div>
        </div>

        <!-- Image preview modal -->
        <div class="image-modal" v-if="showImageModal" @click="closeModal">
            <div class="image-modal-content">
                <img :src="modalImage" alt="Full size image">
            </div>
        </div>

        <!-- Central notification card -->
        <transition name="fade">
            <div class="center-notification" v-if="centerNotification.show" :class="centerNotification.type">
                <div class="center-notification-content">
                    <div class="notification-icon">
                        <i class="fas" :class="centerNotification.type === 'success' ? 'fa-check-circle' :
                           centerNotification.type === 'warning' ? 'fa-exclamation-triangle' : 'fa-info-circle'"></i>
                    </div>
                    <div class="notification-message" v-html="centerNotification.message"></div>
                </div>
                <div class="notification-actions" v-if="centerNotification.showAction">
                    <button v-if="centerNotification.actionType === 'restart'" class="primary-btn"
                        @click="restartServer">
                        Restart Server
                    </button>
                    <button v-if="centerNotification.actionType === 'newSession'" class="primary-btn"
                        @click="createNewSession">
                        New Session
                    </button>
                    <button class="secondary-btn" @click="closeCenterNotification">
                        I know
                    </button>
                </div>
            </div>
        </transition>

        <!-- Add floating control buttons -->
        <!-- Add gradient effect toggle button -->
        <div class="gradient-toggle" @click="toggleGradientEffect" :class="{'gradient-active': gradientEffectEnabled}"
            style="display:none;" id="gradient-toggle-btn">
            <i class="fas fa-paint-brush"></i>
        </div>
    </div>

    <!-- Prism.js for code highlighting -->
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/prism.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-json.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/prismjs@1.29.0/components/prism-python.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/markdown-it/dist/markdown-it.min.js"></script>

    <!-- Êï∞Â≠¶ÂÖ¨ÂºèÂ§ÑÁêÜÂ∑•ÂÖ∑ -->
    <script type="module" src="{{ url_for('utils', filename='mathProcessor.js') }}"></script>
    <!-- ‰∏ªÂ∫îÁî®ËÑöÊú¨ -->
    <script type="module" src="{{ url_for('static', filename='js/chat.js') }}"></script>

    <!-- Page loading script -->
    <script>
        // Hide loading animation after page loads
        window.addEventListener('load', function () {
            setTimeout(function () {
                document.getElementById('page-loader').style.opacity = '0';
                setTimeout(function () {
                    document.getElementById('page-loader').style.display = 'none';
                    // Show gradient effect button
                    const gradientBtn = document.getElementById('gradient-toggle-btn');
                    if (gradientBtn && document.body.classList.contains('dark-theme')) {
                        gradientBtn.style.display = 'flex';
                    } else if (gradientBtn) {
                        gradientBtn.style.display = 'none';
                    }
                }, 500);
            }, 600);
        });
    </script>
</body>

</html>
